{"version":3,"file":"vue-router-plus.js","sources":["../src/utils.js","../src/before/query-options.js","../src/store.js","../src/hook-wrapper.js","../src/vue-router-plus.js"],"sourcesContent":["export const cloneDeep = s => JSON.parse(JSON.stringify(s))","import { cloneDeep } from '../utils'\nconst queryOptions = to => {\n  if ('_f' in to.query) {\n    delete to.query['_f']\n  }\n  const queryOptions = to.meta.queryOptions\n  const formatedQuery = cloneDeep(to.query)\n  if (queryOptions) {\n    for (let queryName in queryOptions) {\n      const query = queryOptions[queryName]\n      const queryType = query.type\n      const queryDefaultValue = query.default\n      if (queryName in to.query && to.query[queryName] !== undefined) {\n        formatedQuery[queryName] = queryType(to.query[queryName])\n      } else {\n        formatedQuery[queryName] = queryDefaultValue\n      }\n    }\n  }\n  to.meta.query = formatedQuery\n}\n\nexport default queryOptions\n","export default {\n  _f: 1,\n  to: {},\n  from: {},\n  next: null,\n  _pageStage: {\n    num: 1,\n    start_timestamp: 0,\n    fullPath: ''\n  },\n  maxRedirect: {\n    count: 20,\n    duration: 3000\n  }\n}\n","import store from './store'\n\nconst replaceHref = (location) => {\n  if (typeof location === 'string' && location) {\n    return location.replace(/_f=[^&]*&?/g, '').replace(/(&|\\?)$/, '')\n  }\n  return ''\n}\nconst createHref = location => {\n  if (typeof location === 'string') {\n    if (location.includes('?')) {\n      location += `&_f=${store._f++}`\n    } else {\n      location += `?_f=${store._f++}`\n    }\n    return location\n  }\n  if (typeof location === 'object') {\n    location.query = location.query || {}\n    location.query._f = store._f++\n    return location\n  }\n  return location\n}\n\nconst hookWrapper = fn =>\n  function(to, from, next) {\n    function _next(arg) {\n      if (_next._isUsed) {\n        throw new Error(\n          `[vue-router-plus] next callback is called more than twice,\"${from.fullPath}\" -> \"${to.fullPath}\"`\n        )\n      }\n\n      // tag the next function is used status\n\n      const newLocation = createHref(arg)\n      _next._isUsed = true\n      next(newLocation)\n    }\n    const _to = to\n    const _from = from\n\n    store.to = _to\n    store.from = from\n    store.next = _next\n    if (replaceHref(store._pageStage.fullPath) === replaceHref(_to.fullPath)) {\n      // 当前栈中存储的路径与即将跳转的路由地址一致\n      // 记录次数\n      store._pageStage.num++\n      let currentTimeStamp = new Date().getTime()\n      // 在当前路径下已持续跳转xx秒,跳转次数超过xx次\n      let currentDuration = currentTimeStamp - store._pageStage.start_timestamp\n      if (\n        currentDuration > store.maxRedirect.duration &&\n        store._pageStage.num > store.maxRedirect.count\n      ) {\n        // 清空记录栈信息\n        store._pageStage.fullPath = ''\n        store._pageStage.num = 1\n        store._pageStage.start_timestamp = 0\n        throw new Error(`[vue-router-plus] current route ${_to.path} is reload to ${store.maxRedirect.count} times in ${store.maxRedirect.duration}ms\n      }`)\n      }\n    } else {\n      // 路径变化,清空记录栈信息\n      store._pageStage.fullPath = _to.fullPath\n      store._pageStage.num = 1\n      store._pageStage.start_timestamp = new Date().getTime()\n    }\n    // use orginal context\n    const ret = fn.call(this, _to, _from, _next)\n    // 形参大于2个\n    if (fn.length > 2) {\n      if (ret && (ret.then || ret.subscribe)) {\n        next(\n          new Error(\n            `[vue-router-plus] can not use next() and (Promise or Observable) together${\n              fn.name ? ' -> ' + fn.name : ''\n            }`\n          )\n        )\n      }\n    } else {\n      if (ret === undefined) {\n        _next()\n        return\n      }\n      if (ret === false) {\n        return\n      }\n      // process promise\n      if (ret.then) {\n        ret\n          .then(() => {\n            _next()\n          })\n          .catch(e => {\n            _next(new Error(e))\n          })\n        return\n      }\n      // process subscribe\n      if (ret.subscribe) {\n        ret.subscribe(\n          () => {\n            _next()\n          },\n          e => {\n            _next(new Error(e))\n          }\n        )\n        return\n      }\n    }\n    return ret\n  }\nexport default hookWrapper\n","import VueRouter from 'vue-router'\nimport queryOptions from './before/query-options'\nimport innerPlusHook from './hook-wrapper'\nimport store from './store'\nlet isHistoryBF = false\n\nclass VueRouterPlus extends VueRouter {\n  static install(Vue) {\n    Vue.use(VueRouter)\n    window.addEventListener('popstate', () => {\n      isHistoryBF = true\n    })\n    Vue.mixin({\n      beforeCreate() {\n        if (this.$route) {\n          Vue.util.defineReactive(this, '$searchQuery', this.$route.meta.query)\n        }\n      },\n      // 修复有其他钩子影响query时需要同步变更\n      watch: {\n        $route(newRoute) {\n          if (newRoute.meta.query) {\n            this.$searchQuery = newRoute.meta.query\n          }\n        }\n      }\n    })\n  }\n  constructor(routeOptions, routeExtraOptions = {\n    maxRedirect: {\n      count: 20,\n      duration: 3000\n    }\n  }) {\n    super(routeOptions)\n    store.maxRedirect = routeExtraOptions.maxRedirect\n    this.beforeEach(queryOptions)\n  }\n  get isHistoryBF() {\n    return isHistoryBF\n  }\n  get to() {\n    return store.to\n  }\n  get from() {\n    return store.from\n  }\n  get next() {\n    return store.next\n  }\n  get maxRedirect() {\n    return this.maxRedirect\n  }\n  beforeEach(fn) {\n    return super.beforeEach(plusHook(fn))\n  }\n  beforeResolve(fn) {\n    return super.beforeResolve(plusHook(fn))\n  }\n  _calcNewLocation(location) {\n    const { route } = this.resolve(location)\n    const newLocation = {\n      path: route.path,\n      query: Object.assign(route.query, {\n        _f: store._f++\n      }),\n      params: route.params,\n      hash: route.hash\n    }\n    return newLocation\n  }\n\n  /**\n   * @param {string} mode replace|push\n   * @param {string|object} location\n   * @param {Function} onComplete\n   * @param {Function} onError\n   */\n  _goto(mode, location, onComplete, onError) {\n    isHistoryBF = false\n    const newLocation = this._calcNewLocation(location)\n    return super[mode](newLocation, onComplete, onError)\n  }\n  push(location, onComplete, onError) {\n    return this._goto('push', location, onComplete, onError)\n  }\n  replace(location, onComplete, onError) {\n    return this._goto('replace', location, onComplete, onError)\n  }\n  // // spa reload current Route and force get Data again\n  reload(onComplete, onError) {\n    const current = this.currentRoute\n    this.replace(current.fullPath, onComplete, onError)\n  }\n}\n\nexport const plusHook = innerPlusHook\nexport default VueRouterPlus\n"],"names":["queryOptions","to","query","s","meta","formatedQuery","JSON","parse","stringify","queryName","queryType","type","queryDefaultValue","undefined","_f","from","next","_pageStage","num","start_timestamp","fullPath","maxRedirect","count","duration","replaceHref","location","replace","createHref","includes","store","_typeof","isHistoryBF","VueRouterPlus","routeOptions","routeExtraOptions","beforeEach","Vue","use","VueRouter","window","addEventListener","mixin","beforeCreate","this","$route","util","defineReactive","watch","newRoute","$searchQuery","fn","plusHook","route","resolve","path","Object","assign","params","hash","mode","onComplete","onError","newLocation","_calcNewLocation","_goto","current","currentRoute","_next","arg","_isUsed","Error","_to","_from","Date","getTime","ret","call","length","then","subscribe","name","e"],"mappings":";;;m7CAAO,ICCDA,EAAe,SAAAC,GACf,OAAQA,EAAGC,cACND,EAAGC,MAAH,ODHcC,ECKjBH,EAAeC,EAAGG,KAAKJ,aACvBK,GDNiBF,ECMSF,EAAGC,MDNPI,KAAKC,MAAMD,KAAKE,UAAUL,QCOlDH,MACG,IAAIS,KAAaT,EAAc,KAC5BE,EAAQF,EAAaS,GACrBC,EAAYR,EAAMS,KAClBC,EAAoBV,UACtBO,KAAaR,EAAGC,YAAiCW,IAAxBZ,EAAGC,MAAMO,GACpCJ,EAAcI,GAAaC,EAAUT,EAAGC,MAAMO,IAE9CJ,EAAcI,GAAaG,EAIjCX,EAAGG,KAAKF,MAAQG,KCnBH,CACbS,GAAI,EACJb,GAAI,GACJc,KAAM,GACNC,KAAM,KACNC,WAAY,CACVC,IAAK,EACLC,gBAAiB,EACjBC,SAAU,IAEZC,YAAa,CACXC,MAAO,GACPC,SAAU,MCVRC,EAAc,SAACC,SACK,iBAAbA,GAAyBA,EAC3BA,EAASC,QAAQ,cAAe,IAAIA,QAAQ,UAAW,IAEzD,IAEHC,EAAa,SAAAF,SACO,iBAAbA,GACLA,EAASG,SAAS,KACpBH,iBAAmBI,EAAMf,MAEzBW,iBAAmBI,EAAMf,MAEpBW,GAEe,WAApBK,EAAOL,IACTA,EAASvB,MAAQuB,EAASvB,OAAS,GACnCuB,EAASvB,MAAMY,GAAKe,EAAMf,KACnBW,GAEFA,GClBLM,GAAc,EAEZC;;uBAsBQC,SAAcC,yDAAoB,CAC5Cb,YAAa,CACXC,MAAO,GACPC,SAAU,0IAGNU,IACNJ,EAAMR,YAAca,EAAkBb,cACjCc,WAAWnC,4RA7BHoC,GACbA,EAAIC,IAAIC,GACRC,OAAOC,iBAAiB,YAAY,WAClCT,GAAc,KAEhBK,EAAIK,MAAM,CACRC,wBACMC,KAAKC,QACPR,EAAIS,KAAKC,eAAeH,KAAM,eAAgBA,KAAKC,OAAOxC,KAAKF,QAInE6C,MAAO,CACLH,gBAAOI,GACDA,EAAS5C,KAAKF,aACX+C,aAAeD,EAAS5C,KAAKF,qDA+BjCgD,wDACeC,EAASD,0CAErBA,2DACeC,EAASD,6CAErBzB,OACP2B,EAAUT,KAAKU,QAAQ5B,GAAvB2B,YACY,CAClBE,KAAMF,EAAME,KACZpD,MAAOqD,OAAOC,OAAOJ,EAAMlD,MAAO,CAChCY,GAAIe,EAAMf,OAEZ2C,OAAQL,EAAMK,OACdC,KAAMN,EAAMM;;;;;;uCAWVC,EAAMlC,EAAUmC,EAAYC,GAChC9B,GAAc,MACR+B,EAAcnB,KAAKoB,iBAAiBtC,2BAC7BkC,kBAAMG,EAAaF,EAAYC,gCAEzCpC,EAAUmC,EAAYC,UAClBlB,KAAKqB,MAAM,OAAQvC,EAAUmC,EAAYC,mCAE1CpC,EAAUmC,EAAYC,UACrBlB,KAAKqB,MAAM,UAAWvC,EAAUmC,EAAYC,kCAG9CD,EAAYC,OACXI,EAAUtB,KAAKuB,kBAChBxC,QAAQuC,EAAQ7C,SAAUwC,EAAYC,8CArDpC9B,oCAGAF,EAAM5B,uCAGN4B,EAAMd,yCAGNc,EAAMb,gDAGN2B,KAAKtB,mBA7CYiB,GA0Ffa,EDvEO,SAAAD,UAClB,SAASjD,EAAIc,EAAMC,YACRmD,EAAMC,MACTD,EAAME,cACF,IAAIC,2EACsDvD,EAAKK,0BAAiBnB,EAAGmB,mBAMrF0C,EAAcnC,EAAWyC,GAC/BD,EAAME,SAAU,EAChBrD,EAAK8C,OAEDS,EAAMtE,EACNuE,EAAQzD,KAEdc,EAAM5B,GAAKsE,EACX1C,EAAMd,KAAOA,EACbc,EAAMb,KAAOmD,EACT3C,EAAYK,EAAMZ,WAAWG,YAAcI,EAAY+C,EAAInD,cAG7DS,EAAMZ,WAAWC,OACM,IAAIuD,MAAOC,UAEO7C,EAAMZ,WAAWE,gBAEtCU,EAAMR,YAAYE,UACpCM,EAAMZ,WAAWC,IAAMW,EAAMR,YAAYC,YAGzCO,EAAMZ,WAAWG,SAAW,GAC5BS,EAAMZ,WAAWC,IAAM,EACvBW,EAAMZ,WAAWE,gBAAkB,EAC7B,IAAImD,gDAAyCC,EAAIjB,8BAAqBzB,EAAMR,YAAYC,2BAAkBO,EAAMR,YAAYE,8BAKpIM,EAAMZ,WAAWG,SAAWmD,EAAInD,SAChCS,EAAMZ,WAAWC,IAAM,EACvBW,EAAMZ,WAAWE,iBAAkB,IAAIsD,MAAOC,cAG1CC,EAAMzB,EAAG0B,KAAKjC,KAAM4B,EAAKC,EAAOL,MAElCjB,EAAG2B,OAAS,EACVF,IAAQA,EAAIG,MAAQH,EAAII,YAC1B/D,EACE,IAAIsD,yFAEApB,EAAG8B,KAAO,OAAS9B,EAAG8B,KAAO,UAKhC,SACOnE,IAAR8D,cACFR,QAGU,IAARQ,YAIAA,EAAIG,iBACNH,EACGG,MAAK,WACJX,cAEK,SAAAc,GACLd,EAAM,IAAIG,MAAMW,UAKlBN,EAAII,sBACNJ,EAAII,WACF,WACEZ,OAEF,SAAAc,GACEd,EAAM,IAAIG,MAAMW,cAMjBN"}